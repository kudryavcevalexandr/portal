<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ü–æ–∏—Å–∫ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã</title>
  <style>
    :root{
      --bg:#ffffff;
      --panel:#f8fafc;
      --panel2:#eef2f7;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --accent:#0284c7;
      --accent2:#7c3aed;
      --warn:#d97706;
      --ok:#059669;
      --bad:#e11d48;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --r: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --glow-1: rgba(14,165,233,.16);
      --glow-2: rgba(124,58,237,.16);
      --top-bg: rgba(255,255,255,.85);
      --top-border: rgba(226,232,240,.9);
      --panel-border: rgba(226,232,240,.9);
      --chip-bg: rgba(248,250,252,.9);
      --chip-border: rgba(226,232,240,.9);
      --tag-bg: rgba(241,245,249,.9);
      --tag-text: #1d4ed8;
      --score-bg: rgba(14,165,233,.12);
      --mark-bg: rgba(14,165,233,.22);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0f14;
        --panel:#101722;
        --panel2:#0f1620;
        --text:#e6eefc;
        --muted:#98a6bd;
        --line:#1f2a3a;
        --accent:#6ee7ff;
        --accent2:#a78bfa;
        --warn:#fbbf24;
        --ok:#34d399;
        --bad:#fb7185;
        --shadow: 0 10px 30px rgba(0,0,0,.35);
        --glow-1: rgba(110,231,255,.10);
        --glow-2: rgba(167,139,250,.10);
        --top-bg: rgba(11,15,20,.65);
        --top-border: rgba(31,42,58,.65);
        --panel-border: rgba(31,42,58,.9);
        --chip-bg: rgba(16,23,34,.7);
        --chip-border: rgba(31,42,58,.9);
        --tag-bg: rgba(11,15,20,.35);
        --tag-text: #cfe3ff;
        --score-bg: rgba(110,231,255,.08);
        --mark-bg: rgba(110,231,255,.18);
      }
    }
    :root[data-theme="dark"]{
      --bg:#0b0f14;
      --panel:#101722;
      --panel2:#0f1620;
      --text:#e6eefc;
      --muted:#98a6bd;
      --line:#1f2a3a;
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --warn:#fbbf24;
      --ok:#34d399;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --glow-1: rgba(110,231,255,.10);
      --glow-2: rgba(167,139,250,.10);
      --top-bg: rgba(11,15,20,.65);
      --top-border: rgba(31,42,58,.65);
      --panel-border: rgba(31,42,58,.9);
      --chip-bg: rgba(16,23,34,.7);
      --chip-border: rgba(31,42,58,.9);
      --tag-bg: rgba(11,15,20,.35);
      --tag-text: #cfe3ff;
      --score-bg: rgba(110,231,255,.08);
      --mark-bg: rgba(110,231,255,.18);
    }
    :root[data-theme="light"]{
      --bg:#ffffff;
      --panel:#f8fafc;
      --panel2:#eef2f7;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --accent:#0284c7;
      --accent2:#7c3aed;
      --warn:#d97706;
      --ok:#059669;
      --bad:#e11d48;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --glow-1: rgba(14,165,233,.16);
      --glow-2: rgba(124,58,237,.16);
      --top-bg: rgba(255,255,255,.85);
      --top-border: rgba(226,232,240,.9);
      --panel-border: rgba(226,232,240,.9);
      --chip-bg: rgba(248,250,252,.9);
      --chip-border: rgba(226,232,240,.9);
      --tag-bg: rgba(241,245,249,.9);
      --tag-text: #1d4ed8;
      --score-bg: rgba(14,165,233,.12);
      --mark-bg: rgba(14,165,233,.22);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 800px at 20% 0%, var(--glow-1), transparent 55%),
                  radial-gradient(1000px 700px at 80% 10%, var(--glow-2), transparent 50%),
                  var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    .top{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: var(--top-bg);
      border-bottom:1px solid var(--top-border);
    }
    .bar{
      display:flex; gap:12px; align-items:center;
      padding:14px 18px;
      max-width:1100px; margin:0 auto;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px; min-width:180px;
    }
    .brand .t{font-weight:700; letter-spacing:.2px}
    .brand .s{font-size:12px; color:var(--muted)}
    .search{
      flex:1;
      display:flex; align-items:center; gap:10px;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--panel-border);
      border-radius: 999px;
      padding:10px 14px;
      box-shadow: var(--shadow);
    }
    .search input{
      flex:1;
      border:0; outline:0; background:transparent;
      color:var(--text);
      font-size:16px;
    }
    .pill{
      font-size:12px; color:var(--muted);
      border:1px solid var(--chip-border);
      border-radius:999px;
      padding:6px 10px;
      background: var(--chip-bg);
      user-select:none;
      white-space:nowrap;
    }
    .btn{
      border:1px solid var(--chip-border);
      background: var(--chip-bg);
      color:var(--text);
      border-radius: 12px;
      padding:10px 12px;
      cursor:pointer;
      transition: transform .05s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:active{transform: translateY(1px)}
    .btn:hover{border-color: color-mix(in srgb, var(--accent) 55%, transparent)}
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      padding-top:16px;
    }
    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--panel-border);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .panel .hd{
      display:flex; justify-content:space-between; align-items:center;
      padding:14px 14px 10px 14px;
      border-bottom:1px solid var(--top-border);
    }
    .panel .hd .left{display:flex; flex-direction:column; gap:4px}
    .panel .hd .title{font-weight:700}
    .panel .hd .sub{font-size:12px;color:var(--muted)}
    .panel .bd{padding:12px 14px}
    .status{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
      font-size:12px; color:var(--muted);
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background: var(--muted);
      display:inline-block;
    }
    .dot.ok{background: var(--ok)}
    .dot.bad{background: var(--bad)}
    .dot.warn{background: var(--warn)}
    .row{
      display:flex; justify-content:space-between; gap:12px;
      padding:12px 0;
      border-bottom:1px dashed var(--top-border);
    }
    .row:last-child{border-bottom:0}
    .main{
      display:flex; flex-direction:column; gap:6px; min-width:0;
    }
    .name{
      font-size:15px; line-height:1.25;
      font-weight:650;
      word-break:break-word;
    }
    .meta{
      display:flex; flex-wrap:wrap; gap:8px; align-items:center;
      font-size:12px; color:var(--muted);
    }
    .tag{
      font-family: var(--mono);
      border:1px solid var(--chip-border);
      background: var(--tag-bg);
      padding:4px 8px;
      border-radius: 999px;
      color: var(--tag-text);
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .crumbs{
      font-size:12px;color:var(--muted);
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
    }
    .side{
      text-align:right;
      display:flex; flex-direction:column; gap:8px; align-items:flex-end;
      flex:0 0 auto;
    }
    .score{
      font-family: var(--mono);
      font-size:12px;
      color:var(--tag-text);
      border:1px solid var(--chip-border);
      background: var(--score-bg);
      padding:6px 10px;
      border-radius: 12px;
    }
    .skeleton{
      background: linear-gradient(90deg,
        color-mix(in srgb, var(--muted) 35%, transparent),
        color-mix(in srgb, var(--muted) 12%, transparent),
        color-mix(in srgb, var(--muted) 35%, transparent)
      );
      background-size: 200% 100%;
      animation: sh 1.15s infinite;
      border-radius: 12px;
      height: 14px;
    }
    @keyframes sh{0%{background-position:0% 50%}100%{background-position:200% 50%}}
    .kbd{
      font-family:var(--mono);
      font-size:11px;
      padding:3px 6px;
      border-radius:8px;
      border:1px solid var(--chip-border);
      background: var(--tag-bg);
      color: var(--tag-text);
    }
    .input-field{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--chip-border);
      background: var(--tag-bg);
      color:var(--text);
      outline:none;
    }
    .input-field--small{width:160px}
    .pager{
      display:flex; gap:10px; align-items:center; justify-content:flex-end;
      padding:12px 14px;
      border-top:1px solid var(--top-border);
      background: color-mix(in srgb, var(--panel2) 70%, transparent);
    }
    .pager .muted{color:var(--muted); font-size:12px}
    mark{
      background: var(--mark-bg);
      color: var(--text);
      padding:0 3px;
      border-radius:6px;
    }

    @media (max-width:720px){
      .brand{display:none}
      .bar{padding:12px}
      .row{flex-direction:column; align-items:flex-start}
      .side{align-items:flex-start; text-align:left}
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="bar">
      <div class="brand">
        <div class="t">–ü–æ–∏—Å–∫ –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã</div>
        <div class="s">–±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ + –∫—Ä–∞—Å–∏–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω–∞—è –≤—ã–¥–∞—á–∞</div>
      </div>

      <div class="search" role="search">
        <span class="pill">API</span>
        <input id="q" type="search" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –í–í–ì–Ω–≥(–ê)-LS 3√ó2.5 –∏–ª–∏ ‚Äú—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä 10 –∫–í‚Äù" autocomplete="off" />
        <span class="pill"><span class="kbd">Enter</span> –∏—Å–∫–∞—Ç—å</span>
      </div>

      <button class="btn" id="themeToggle" type="button" title="–¢—ë–º–Ω–∞—è —Ç–µ–º–∞" aria-pressed="false">üåô</button>
      <button class="btn" id="cfgBtn" title="–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏">‚öôÔ∏è</button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">
      <div class="panel">
        <div class="hd">
          <div class="left">
            <div class="title">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
            <div class="sub" id="subline">–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏ –Ω–∞–∂–º–∏—Ç–µ Enter</div>
          </div>
          <div class="status" id="status">
            <span class="dot warn" id="apiDot"></span>
            <span id="apiText">API: –Ω–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ</span>
            <span class="pill">–ø–æ–¥—Å–∫–∞–∑–∫–∞: <span class="kbd">Ctrl</span>+<span class="kbd">K</span> —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–∏—Å–∫</span>
          </div>
        </div>

        <div class="bd" id="list">
          <!-- results render here -->
        </div>

        <div class="pager">
          <span class="muted" id="rangeText"></span>
          <button class="btn" id="prevBtn">‚Üê</button>
          <button class="btn" id="nextBtn">‚Üí</button>
        </div>
      </div>

      <div class="panel" id="cfgPanel" style="display:none;">
        <div class="hd">
          <div class="left">
            <div class="title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div class="sub">–ø–æ–º–µ–Ω—è–π—Ç–µ –∞–¥—Ä–µ—Å API –∏ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏</div>
          </div>
          <button class="btn" id="closeCfg">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
        <div class="bd" style="display:grid; gap:10px;">
          <div style="display:grid; gap:6px;">
            <div style="font-size:12px;color:var(--muted);">API_BASE</div>
            <input id="apiBaseInp" class="input-field" placeholder="http://localhost:8080" />
            <div style="font-size:12px;color:var(--muted);">
              –î–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å —ç–Ω–¥–ø–æ–∏–Ω—Ç <span class="tag">/api/search</span> —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ <span class="tag">q</span>, <span class="tag">size</span>, <span class="tag">from</span>.
            </div>
          </div>

          <div style="display:grid; gap:6px;">
            <div style="font-size:12px;color:var(--muted);">–†–∞–∑–º–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã (size)</div>
            <input id="sizeInp" class="input-field input-field--small" type="number" min="5" max="100" />
          </div>

          <div style="font-size:12px;color:var(--muted);line-height:1.45;">
            –ï—Å–ª–∏ –≤–∞—à–µ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ‚Äú–ø–ª–æ—Å–∫–∏–π‚Äù —Ñ–æ—Ä–º–∞—Ç ‚Äî –æ–∫. –ï—Å–ª–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç ‚Äú—Å—ã—Ä–æ–π‚Äù OpenSearch ‚Äî
            —Ç–æ–∂–µ –æ–∫: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–∞–º–∞ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –æ—Ç–≤–µ—Ç.
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ====== CONFIG ======
  let API_BASE = localStorage.getItem("API_BASE") || "http://localhost:8080"; // –ø–æ–º–µ–Ω—è–π—Ç–µ –Ω–∞ http://localhost:8010 –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
  let PAGE_SIZE = Number(localStorage.getItem("PAGE_SIZE") || 20);

  // ====== STATE ======
  let lastQuery = "";
  let from = 0;
  let total = 0;
  let inflight = null;

  const elQ = document.getElementById("q");
  const elList = document.getElementById("list");
  const elSub = document.getElementById("subline");
  const elRange = document.getElementById("rangeText");
  const apiDot = document.getElementById("apiDot");
  const apiText = document.getElementById("apiText");
  const themeToggle = document.getElementById("themeToggle");
  const themeRoot = document.documentElement;

  const prevBtn = document.getElementById("prevBtn");
  const nextBtn = document.getElementById("nextBtn");

  // Config UI
  const cfgBtn = document.getElementById("cfgBtn");
  const cfgPanel = document.getElementById("cfgPanel");
  const closeCfg = document.getElementById("closeCfg");
  const apiBaseInp = document.getElementById("apiBaseInp");
  const sizeInp = document.getElementById("sizeInp");
  const THEME_KEY = "theme";

  apiBaseInp.value = API_BASE;
  sizeInp.value = PAGE_SIZE;

  function getPreferredTheme(){
    return window.matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light";
  }

  function updateThemeToggle(){
    const current = themeRoot.getAttribute("data-theme") || getPreferredTheme();
    const isDark = current === "dark";
    themeToggle.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
    themeToggle.setAttribute("aria-pressed", isDark ? "true" : "false");
    themeToggle.title = isDark ? "–°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞" : "–¢—ë–º–Ω–∞—è —Ç–µ–º–∞";
  }

  function applyTheme(theme){
    if(theme){
      themeRoot.setAttribute("data-theme", theme);
    }else{
      themeRoot.removeAttribute("data-theme");
    }
    updateThemeToggle();
  }

  const savedTheme = localStorage.getItem(THEME_KEY);
  if(savedTheme === "dark" || savedTheme === "light"){
    applyTheme(savedTheme);
  }else{
    updateThemeToggle();
  }

  themeToggle.addEventListener("click", () => {
    const current = themeRoot.getAttribute("data-theme") || getPreferredTheme();
    const next = current === "dark" ? "light" : "dark";
    applyTheme(next);
    localStorage.setItem(THEME_KEY, next);
  });

  cfgBtn.onclick = () => { cfgPanel.style.display = "block"; };
  closeCfg.onclick = () => { cfgPanel.style.display = "none"; };

  apiBaseInp.addEventListener("change", () => {
    API_BASE = apiBaseInp.value.trim() || API_BASE;
    localStorage.setItem("API_BASE", API_BASE);
    pingApi();
  });
  sizeInp.addEventListener("change", () => {
    PAGE_SIZE = Math.max(5, Math.min(100, Number(sizeInp.value || 20)));
    localStorage.setItem("PAGE_SIZE", String(PAGE_SIZE));
  });

  // Ctrl+K focus
  window.addEventListener("keydown", (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === "k") {
      e.preventDefault();
      elQ.focus();
      elQ.select();
    }
  });

  // Enter = search
  elQ.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      from = 0;
      doSearch(elQ.value.trim());
    }
  });

  prevBtn.onclick = () => {
    if (from <= 0) return;
    from = Math.max(0, from - PAGE_SIZE);
    doSearch(lastQuery);
  };
  nextBtn.onclick = () => {
    if (from + PAGE_SIZE >= total) return;
    from = from + PAGE_SIZE;
    doSearch(lastQuery);
  };

  function setApiStatus(kind, text){
    apiDot.className = "dot " + (kind || "");
    apiText.textContent = text;
  }

  async function pingApi(){
    // –º—è–≥–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
    try{
      setApiStatus("warn", "API: –ø—Ä–æ–≤–µ—Ä—è–µ–º‚Ä¶");
      const r = await fetch(API_BASE.replace(/\/$/,"") + "/api/health", { method:"GET" });
      if (r.ok) setApiStatus("ok", "API: –¥–æ—Å—Ç—É–ø–Ω–æ");
      else setApiStatus("warn", "API: –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ /api/health –Ω–µ ok");
    }catch(err){
      setApiStatus("bad", "API: –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ (–ø—Ä–æ–≤–µ—Ä—å—Ç–µ API_BASE)");
    }
  }

  function renderSkeleton(){
    elList.innerHTML = "";
    for(let i=0;i<6;i++){
      const row = document.createElement("div");
      row.className = "row";
      row.innerHTML = `
        <div class="main">
          <div class="skeleton" style="width:${60 + Math.random()*30}%;"></div>
          <div class="skeleton" style="width:${40 + Math.random()*40}%; height:12px; opacity:.75;"></div>
        </div>
        <div class="side">
          <div class="skeleton" style="width:90px; height:26px;"></div>
        </div>`;
      elList.appendChild(row);
    }
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[&<>"']/g, (c) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[c]));
  }

  function highlight(text, q){
    if(!q) return escapeHtml(text);
    const safe = escapeHtml(text);
    const parts = q.split(/\s+/).filter(Boolean).slice(0,6);
    if(!parts.length) return safe;
    // –ø—Ä–æ—Å—Ç–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –±–µ–∑ —Ä–µ–≥—ç–∫—Å–ø-–∏–Ω—ä–µ–∫—Ü–∏–π
    let out = safe;
    for(const p of parts){
      const pp = escapeHtml(p);
      if(pp.length < 2) continue;
      out = out.replaceAll(pp, `<mark>${pp}</mark>`);
    }
    return out;
  }

  function normalizeResponse(raw){
    // –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º:
    //  A) { total: 123, hits: [{id, code, name, unit, path, level, score}] }
    //  B) OpenSearch: { hits: { total: {value}, hits: [{ _id, _score, _source: {...}}] } }
    if(raw && Array.isArray(raw.hits) && typeof raw.total !== "undefined"){
      return {
        total: Number(raw.total) || 0,
        items: raw.hits.map(h => ({
          id: h.id ?? h._id ?? "",
          code: h.code ?? h.nomenclature_code ?? h.code_x ?? "",
          name: h.name ?? h.nomenclature_name ?? h.name_x ?? "",
          unit: h.unit ?? h.ed_izm ?? "",
          path: h.path ?? h.breadcrumbs ?? "",
          level: h.level ?? "",
          parent_id: h.parent_id ?? "",
          score: h.score ?? "",
          raw: h
        }))
      };
    }

    const osHits = raw?.hits?.hits || [];
    const osTotal = raw?.hits?.total?.value ?? raw?.hits?.total ?? 0;

    return {
      total: Number(osTotal) || 0,
      items: osHits.map(h => {
        const s = h?._source || {};
        return {
          id: h?._id ?? s.id ?? "",
          code: s.code ?? s.nomenclature_code ?? s.code_x ?? "",
          name: s.name ?? s.nomenclature_name ?? s.name_x ?? "",
          unit: s.unit ?? s.ed_izm ?? "",
          path: s.path ?? s.breadcrumbs ?? "",
          level: s.level ?? "",
          parent_id: s.parent_id ?? "",
          score: h?._score ?? "",
          raw: s
        };
      })
    };
  }

  function renderList(items, q){
    elList.innerHTML = "";
    if(!items.length){
      elList.innerHTML = `<div style="color:var(--muted);padding:6px 0;">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å.</div>`;
      return;
    }

    for(const it of items){
      const row = document.createElement("div");
      row.className = "row";

      const nameHtml = highlight(it.name || "(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)", q);
      const code = escapeHtml(it.code || "");
      const unit = escapeHtml(it.unit || "");
      const path = escapeHtml(it.path || "");
      const level = escapeHtml(it.level || "");
      const id = escapeHtml(it.id || "");
      const score = (it.score === "" || it.score === null || typeof it.score === "undefined")
        ? ""
        : String(it.score).slice(0, 8);

      row.innerHTML = `
        <div class="main">
          <div class="name">${nameHtml}</div>
          <div class="meta">
            ${code ? `<span class="tag">${code}</span>` : ``}
            ${unit ? `<span class="tag">${unit}</span>` : ``}
            ${level ? `<span class="tag">L${level}</span>` : ``}
            ${id ? `<span class="tag" title="id">${id}</span>` : ``}
          </div>
          ${path ? `<div class="crumbs" title="${path}">${path}</div>` : ``}
        </div>
        <div class="side">
          ${score ? `<div class="score">score: ${escapeHtml(score)}</div>` : ``}
          <button class="btn" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥" data-copy="${code}">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
      `;

      // copy handler
      row.querySelector("[data-copy]")?.addEventListener("click", async (e) => {
        const v = e.currentTarget.getAttribute("data-copy") || "";
        try{
          await navigator.clipboard.writeText(v);
          e.currentTarget.textContent = "–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ";
          setTimeout(()=> e.currentTarget.textContent = "–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å", 900);
        }catch(_){
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å (–±—Ä–∞—É–∑–µ—Ä –∑–∞–ø—Ä–µ—Ç–∏–ª). –ö–æ–¥: " + v);
        }
      });

      elList.appendChild(row);
    }
  }

  async function doSearch(q){
    lastQuery = q;
    if(!q){
      elSub.textContent = "–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å –∏ –Ω–∞–∂–º–∏—Ç–µ Enter";
      elRange.textContent = "";
      elList.innerHTML = `<div style="color:var(--muted);padding:6px 0;">–ü—Ä–∏–º–µ—Ä: <span class="tag">–∫–∞–±–µ–ª—å –≤–≤–≥–Ω–≥</span>, <span class="tag">—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ç–æ—Ä 10</span>, <span class="tag">–Ω–∞—Å–æ—Å</span></div>`;
      return;
    }

    // cancel previous
    if(inflight) inflight.abort();
    inflight = new AbortController();

    renderSkeleton();
    elSub.textContent = `–ò—â–µ–º ‚Äú${q}‚Äù‚Ä¶`;
    elRange.textContent = "";

    const url = new URL(API_BASE.replace(/\/$/,"") + "/api/search");
    url.searchParams.set("q", q);
    url.searchParams.set("size", String(PAGE_SIZE));
    url.searchParams.set("from", String(from));

    try{
      const t0 = performance.now();
      const r = await fetch(url.toString(), { signal: inflight.signal });
      if(!r.ok) throw new Error("HTTP " + r.status);

      const raw = await r.json();
      const norm = normalizeResponse(raw);

      total = norm.total || 0;

      const t1 = performance.now();
      const ms = Math.round(t1 - t0);

      const start = total ? (from + 1) : 0;
      const end = Math.min(from + PAGE_SIZE, total);

      elSub.textContent = `–ù–∞–π–¥–µ–Ω–æ: ${total} ‚Ä¢ –≤—Ä–µ–º—è: ${ms} –º—Å`;
      elRange.textContent = total ? `–ø–æ–∫–∞–∑–∞–Ω–æ ${start}‚Äì${end} –∏–∑ ${total}` : ``;

      prevBtn.disabled = (from <= 0);
      nextBtn.disabled = (from + PAGE_SIZE >= total);

      renderList(norm.items, q);

      setApiStatus("ok", "API: –¥–æ—Å—Ç—É–ø–Ω–æ");
    }catch(err){
      if(err.name === "AbortError") return;
      setApiStatus("bad", "API: –æ—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞");
      elSub.textContent = "–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: –ø—Ä–æ–≤–µ—Ä—å—Ç–µ API_BASE –∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç /api/search";
      elList.innerHTML = `
        <div style="color:var(--bad);padding:6px 0;">
          <div style="font-weight:700;">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</div>
          <div style="color:var(--muted);margin-top:6px;">
            URL: <span class="tag">${escapeHtml(url.toString())}</span><br/>
            –û—à–∏–±–∫–∞: <span class="tag">${escapeHtml(err.message || String(err))}</span>
          </div>
        </div>`;
      prevBtn.disabled = true;
      nextBtn.disabled = true;
    }
  }

  // initial
  pingApi();
  doSearch("");

</script>
</body>
</html>
